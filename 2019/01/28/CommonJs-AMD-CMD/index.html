<!DOCTYPE html><html class="theme-next mist use-motion" lang=""><head><meta name="generator" content="Hexo 3.8.0"><meta name="google-site-verification" content="FnF7s_Oua_B--J6sVoLNMuQXIJlIDwTDWRJkngNZcbI"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="CommonJS/AMD/CMD,"><link rel="alternate" href="/atom.xml" title="Honey" type="application/atom+xml"><meta name="description" content="为什么模块很重要？   因为有了模块，我们就可以更方便地使用别人的代码，想要什么功能，就加载什么模块。但是，这样做有一个前提，那就是大家必须以同样的方式编写模块，否则你有你的写法，我有我的写法，岂不是乱了套！"><meta name="keywords" content="CommonJS&#x2F;AMD&#x2F;CMD"><meta property="og:type" content="article"><meta property="og:title" content="js模块化编程弄懂CommonJS和AMD&#x2F;CMD！"><meta property="og:url" content="https://zhanghuaxiao.github.io/2019/01/28/CommonJs-AMD-CMD/index.html"><meta property="og:site_name" content="Honey"><meta property="og:description" content="为什么模块很重要？   因为有了模块，我们就可以更方便地使用别人的代码，想要什么功能，就加载什么模块。但是，这样做有一个前提，那就是大家必须以同样的方式编写模块，否则你有你的写法，我有我的写法，岂不是乱了套！"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2019-01-28T09:14:51.603Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="js模块化编程弄懂CommonJS和AMD&#x2F;CMD！"><meta name="twitter:description" content="为什么模块很重要？   因为有了模块，我们就可以更方便地使用别人的代码，想要什么功能，就加载什么模块。但是，这样做有一个前提，那就是大家必须以同样的方式编写模块，否则你有你的写法，我有我的写法，岂不是乱了套！"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://zhanghuaxiao.github.io/2019/01/28/CommonJs-AMD-CMD/"><title>js模块化编程弄懂CommonJS和AMD/CMD！ | Honey</title></head><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><body itemscope="" itemtype="http://schema.org/WebPage" lang="default"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/Zhanghuaxiao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Honey</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhanghuaxiao.github.io/2019/01/28/CommonJs-AMD-CMD/"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="Honey"><meta itemprop="description" content=""><meta itemprop="image" content="http://b-ssl.duitang.com/uploads/item/201411/01/20141101001054_u5MPu.jpeg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Honey"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">js模块化编程弄懂CommonJS和AMD/CMD！</h1><div class="post-meta"> <span class="post-time"><span class="post-meta-item-icon">发表于</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-28T11:40:04+08:00">2019-01-28</time></span> <span class="post-category"><span class="post-meta-divider">|</span> 分类与 <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">4.7k 字</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时间大约</span> <span title="阅读时间">18 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote class="blockquote-center"><p>为什么模块很重要？</p></blockquote><p>因为有了模块，我们就可以更方便地使用别人的代码，想要什么功能，就加载什么模块。<br>但是，这样做有一个前提，那就是大家必须以同样的方式编写模块，否则你有你的写法，我有我的写法，岂不是乱了套！<br><a id="more"></a></p><blockquote><p><a href="https://www.cnblogs.com/chenguangliang/p/5856701.html" target="_blank" rel="noopener">原文链接</a></p></blockquote><h1 id="CommonJS"><a href="#CommonJS" class="headerlink" title="CommonJS"></a>CommonJS</h1><p> 一开始大家都认为JS是辣鸡，没什么用，官方定义的API只能构建基于浏览器的应用程序，逗我呢，这太狭隘了吧(用了个高端词，嘎嘎)，CommonJS就按耐不住了，CommonJS API定义很多普通应用程序（主要指非浏览器的应用）使用的API，从而填补了这个空白。它的终极目标是提供一个类似Python，Ruby和Java标准库。这样的话，开发者可以使用CommonJS API编写应用程序，然后这些应用可以运行在不同的JavaScript解释器和不同的主机环境中。<br>在兼容CommonJS的系统中，你可以使用JavaScript开发以下程序：</p><p>(1).服务器端JavaScript应用程序<br>(2).命令行工具<br>(3).图形界面应用程序<br>(4).混合应用程序（如，Titanium或Adobe AIR）</p><p>2009年，美国程序员Ryan Dahl创造了node.js项目，将javascript语言用于服务器端编程。这标志”Javascript模块化编程”正式诞生。因为老实说，在浏览器环境下，没有模块也不是特别大的问题，毕竟网页程序的复杂性有限；但是在服务器端，一定要有模块，与操作系统和其他应用程序互动，否则根本没法编程。NodeJS是CommonJS规范的实现，webpack 也是以CommonJS的形式来书写。</p><p>node.js的<a href="https://nodejs.org/docs/latest/api/modules.html" target="_blank" rel="noopener">模块系统</a>，就是参照<a href="http://wiki.commonjs.org/wiki/Modules/1.1" target="_blank" rel="noopener">CommonJS</a>规范实现的。在CommonJS中，有一个全局性方法require()，用于加载模块。假定有一个数学模块math.js，就可以像下面这样加载。</p><p>var math = require(‘math’);</p><p>然后，就可以调用模块提供的方法：</p><p>　　var math = require(‘math’);</p><pre><code>math.add(2,3); // 5
</code></pre><p>CommonJS定义的模块分为:{模块引用(require)} {模块定义(exports)} {模块标识(module)}</p><p>require()用来引入外部模块；exports对象用于导出当前模块的方法或变量，唯一的导出口；module对象就代表模块本身。</p><p>虽说Node遵循CommonJS的规范，但是相比也是做了一些取舍，填了一些新东西的。</p><p>不过，说了CommonJS也说了Node，那么我觉得也得先了解下NPM了。NPM作为Node的包管理器，不是为了帮助Node解决依赖包的安装问题嘛，那它肯定也要遵循CommonJS规范啦，它遵循包规范（还是理论）的。CommonJS WIKI讲了它的历史，还介绍了modules和packages等。</p><p>下面讲讲commonJS的原理以及简易实现：</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a><font color="#0099ff" size="3" face="黑体">原理</font></h2><p>浏览器不支持CommonJS原因，在于缺少四个Node.js环境变量</p><blockquote><ul><li>module</li><li>exports</li><li>require</li><li>global<br>只要能提供这4个变量，浏览器就能加载CommonJS模块<br>下面一个简单示例</li></ul></blockquote><pre><code>var module = {
    exports : {}
};

(function(module,exports){
    exports.multiply = function(n){return n*100}
}(module,module.exports))

var f = module.exports.multiply;
f(5) // 500
</code></pre><p>上面代码向一个立即执行函数提供 module 和 exports 两个外部变量，模块就放在这个立即执行函数里面。模块的输出值放在 module.exports 之中，这样就实现了模块的加载。</p><h2 id="Browserify-的实现"><a href="#Browserify-的实现" class="headerlink" title="Browserify 的实现"></a><font color="#0099ff" size="3" face="黑体">Browserify 的实现</font></h2><p>知道了原理，就能做出工具了。<a href="http://browserify.org/" target="_blank" rel="noopener">Browserify</a> 是目前最常用的 CommonJS 格式转换的工具。</p><p>请看一个例子，main.js 模块加载 foo.js 模块。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// foo.js</span><br><span class="line">module.exports = function(x) &#123;</span><br><span class="line">console.log(x);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// main.js</span><br><span class="line">var foo = require(&quot;./foo&quot;);</span><br><span class="line">foo(&quot;Hi&quot;);</span><br></pre></td></tr></table></figure><p></p><pre><code>使用下面的命令，就能将main.js转为浏览器可用的格式。
</code></pre><p>$ browserify main.js &gt; compiled.js<br>Browserify到底做了什么？安装一下browser-unpack，就能看清楚了。<br>$ npm install browser-unpack -g<br>然后，将前面生成的compile.js解包。<br> $ browser-unpack &lt; compiled.js<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;id&quot;:1,</span><br><span class="line">        &quot;source&quot;:&quot;module.exports = function(x) &#123;\n  console.log(x);\n&#125;;&quot;,</span><br><span class="line">        &quot;deps&quot;:&#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;id&quot;:2,</span><br><span class="line">        &quot;source&quot;:&quot;var foo = require(\&quot;./foo\&quot;);\nfoo(\&quot;Hi\&quot;);&quot;,</span><br><span class="line">        &quot;deps&quot;:&#123;&quot;./foo&quot;:1&#125;,</span><br><span class="line">        &quot;entry&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">] </span><br></pre></td></tr></table></figure><br>可以看到，browerify 将所有模块放入一个数组，id 属性是模块的编号，source 属性是模块的源码，deps 属性是模块的依赖。<p></p><p>因为main.js加载了foo.js,所以deps属性就指定./foo对应1号模块。执行时候，浏览器遇到require(./foo)语句，就自动执行1好模块的source属性，并将执行后module.exports属性值输出</p><h2 id="Tiny-Browser-Require"><a href="#Tiny-Browser-Require" class="headerlink" title="Tiny Browser Require"></a><font color="#0099ff" size="3" face="黑体">Tiny Browser Require</font></h2><p>虽然 Browserify 很强大，但不能在浏览器里操作，有时就很不方便。<br>我根据 <a href="https://github.com/mochajs/mocha" target="_blank" rel="noopener">mocha</a> 的内部实现，做了一个纯浏览器的 CommonJS 模块加载器 <a href="https://github.com/ruanyf/tiny-browser-require" target="_blank" rel="noopener">tiny-browser-require</a> 。完全不需要命令行，直接放进浏览器即可，所有代码只有30多行。</p><p>它的逻辑非常简单，就是把模块读入数组，加载路径就是模块的id。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  function require(p)&#123;</span><br><span class="line">  var path = require.resolve(p); //node.js语法加载当前模块目录下的绝对路径</span><br><span class="line">  var mod = require.modules[path];</span><br><span class="line">  if (!mod) throw new Error(&apos;failed to require &quot;&apos; + p + &apos;&quot;&apos;);</span><br><span class="line">  if (!mod.exports) &#123;</span><br><span class="line">    mod.exports = &#123;&#125;;</span><br><span class="line">    mod.call(mod.exports, mod, mod.exports, require.relative(path));</span><br><span class="line">  &#125;</span><br><span class="line">  return mod.exports;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">require.modules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">require.resolve = function (path)&#123;</span><br><span class="line">  var orig = path;</span><br><span class="line">  var reg = path + &apos;.js&apos;;</span><br><span class="line">  var index = path + &apos;/index.js&apos;;</span><br><span class="line">  return require.modules[reg] &amp;&amp; reg</span><br><span class="line">    || require.modules[index] &amp;&amp; index</span><br><span class="line">    || orig;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">require.register = function (path, fn)&#123;</span><br><span class="line">  require.modules[path] = fn;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">require.relative = function (parent) &#123;</span><br><span class="line">  return function(p)&#123;</span><br><span class="line">    if (&apos;.&apos; != p.charAt(0)) return require(p);</span><br><span class="line">    var path = parent.split(&apos;/&apos;);</span><br><span class="line">    var segs = p.split(&apos;/&apos;);</span><br><span class="line">    path.pop();</span><br><span class="line"></span><br><span class="line">    for (var i = 0; i &lt; segs.length; i++) &#123;</span><br><span class="line">      var seg = segs[i];</span><br><span class="line">      if (&apos;..&apos; == seg) path.pop();</span><br><span class="line">      else if (&apos;.&apos; != seg) path.push(seg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return require(path.join(&apos;/&apos;));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>使用的时候，先将上面的代码放入页面。然后，将模块放在如下的立即执行函数里面，就可以调用了。<p></p><pre><code>&lt;script src=&quot;require.js&quot; /&gt;
&lt;script&gt;
    require.register(&quot;moduleId&quot;, function(module, exports, require){
    // Module code goes here
    });
    var result = require(&quot;moduleId&quot;);
&lt;/script&gt;
</code></pre><p>还是以前面的 main.js 加载 foo.js 为例。</p><pre><code>require.register(&quot;./foo.js&quot;, function(module, exports, require){
module.exports = function(x) {
    console.log(x);
    };
});

var foo = require(&quot;./foo.js&quot;);
foo(&quot;Hi&quot;);
</code></pre><p>注意，这个库只模拟了 require 、module 、exports 三个变量，如果模块还用到了 global 或者其他 Node 专有变量（比如 process），就通过立即执行函数提供即可。</p><h1 id="AMD"><a href="#AMD" class="headerlink" title="AMD"></a>AMD</h1><p>基于commonJS规范的nodeJS出来以后，服务端的模块概念已经形成，很自然地，大家就想要客户端模块。而且最好两者能够兼容，一个模块不用修改，在服务器和浏览器都可以运行。但是，由于一个重大的局限，使得CommonJS规范不适用于浏览器环境。还是上面的代码，如果在浏览器中运行，会有一个很大的问题，你能看出来吗？</p><blockquote><p>var math = require(‘math’);<br>math.add(2, 3);</p></blockquote><p>第二行math.add(2, 3)，在第一行require(‘math’)之后运行，因此必须等math.js加载完成。也就是说，如果加载时间很长，整个应用就会停在那里等。<font color="red">您会注意到 require 是同步的。</font></p><p>这对服务器端不是一个问题，因为所有的模块都存放在本地硬盘，可以同步加载完成，等待时间就是硬盘的读取时间。但是，对于浏览器，这却是一个大问题，因为模块都放在服务器端，等待时间取决于网速的快慢，可能要等很长时间，浏览器处于”假死”状态。</p><p>因此，浏览器端的模块，不能采用”同步加载”（synchronous），只能采用”异步加载”（asynchronous）。这就是AMD规范诞生的背景。</p><p>CommonJS是主要为了JS在后端的表现制定的，他是不适合前端的，AMD(异步模块定义)出现了，它就主要为前端JS的表现制定规范。</p><p><a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank" rel="noopener">AMD</a>是”Asynchronous Module Definition”的缩写，意思就是”异步模块定义”。它采用异步方式加载模块，模块的加载不影响它后面语句的运行。所有依赖这个模块的语句，都定义在一个回调函数中，等到加载完成之后，这个回调函数才会运行。</p><p>AMD也采用require()语句加载模块，但是不同于CommonJS，它要求两个参数：</p><pre><code>require([module], callback);
</code></pre><p>第一个参数[module]，是一个数组，里面的成员就是要加载的模块；第二个参数callback，则是加载成功之后的回调函数。如果将前面的代码改写成AMD形式，就是下面这样：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">require([&apos;math&apos;], function (math) &#123;</span><br><span class="line">    math.add(2, 3);</span><br><span class="line">　&#125;);</span><br></pre></td></tr></table></figure><p></p><p>math.add()与math模块加载不是同步的，浏览器不会发生假死。所以很显然，AMD比较适合浏览器环境。目前，主要有两个Javascript库实现了AMD规范：<a href="https://requirejs.org/" target="_blank" rel="noopener">require.js</a>和<a href="https://github.com/cujojs/curl" target="_blank" rel="noopener">curl.js</a>。</p> <font color="red">RequireJS就是实现了AMD规范的呢。</font><br><font size="2">详细概括：下面以RequireJS为例说明AMD规范</font><h2 id="为什么要用require-js？"><a href="#为什么要用require-js？" class="headerlink" title="为什么要用require.js？"></a><font color="#0099ff" size="3" face="黑体">为什么要用require.js？</font></h2><p>最早的时候，所有Javascript代码都写在一个文件里面，只要加载这一个文件就够了。后来，代码越来越多，一个文件不够了，必须分成多个文件，依次加载。下面的网页代码，相信很多人都见过。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;1.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;2.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;3.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;4.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;5.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;6.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><br>这段代码依次加载多个js文件。<br>这样的写法有很大的缺点。首先，加载的时候，浏览器会停止网页渲染，加载文件越多，网页失去响应的时间就会越长；其次，由于js文件之间存在依赖关系，因此必须严格保证加载顺序（比如上例的1.js要在2.js的前面），依赖性最大的模块一定要放到最后加载，当依赖关系很复杂的时候，代码的编写和维护都会变得困难。<p></p><p>require.js的诞生，就是为了解决这两个问题：</p><blockquote><p>(1) 实现js文件的异步加载，避免网页失去响应；<br>(2) 管理模块之间的依赖性，便于代码的编写和维护。</p></blockquote><h2 id="require-js的加载"><a href="#require-js的加载" class="headerlink" title="require.js的加载"></a><font color="#0099ff" size="3" face="黑体">require.js的加载</font></h2><p>使用require.js的第一步，是先去官方网站<a href="https://requirejs.org/docs/download.html" target="_blank" rel="noopener">下载</a>最新版本。<br>下载后，假定把它放在js子目录下面，就可以加载了。</p><pre><code>&lt;script src=&quot;js/require.js&quot;&gt;&lt;/script&gt;
</code></pre><p>有人可能会想到，加载这个文件，也可能造成网页失去响应。解决办法有两个，一个是把它放在网页底部加载，另一个是写成下面这样：</p><pre><code>&lt;script src=&quot;js/require.js&quot; defer async=&quot;true&quot; &gt;&lt;/script&gt;
</code></pre><p>async属性表明这个文件需要异步加载，避免网页失去响应。IE不支持这个属性，只支持defer，所以把defer也写上。<br>加载require.js以后，下一步就要加载我们自己的代码了。假定我们自己的代码文件是main.js，也放在js目录下面。那么，只需要写成下面这样就行了：</p><pre><code>&lt;script src=&quot;js/require.js&quot; data-main=&quot;js/main&quot;&gt;&lt;/script&gt;
</code></pre><p>data-main属性的作用是，指定网页程序的主模块。在上例中，就是js目录下面的main.js，这个文件会第一个被require.js加载。由于require.js默认的文件后缀名是js，所以可以把main.js简写成main。</p><h2 id="主模块的写法"><a href="#主模块的写法" class="headerlink" title="主模块的写法"></a><font color="#0099ff" size="3" face="黑体">主模块的写法</font></h2><p>上一节的main.js，我把它称为”主模块”，意思是整个网页的入口代码。它有点像C语言的main()函数，所有代码都从这儿开始运行。<br>下面就来看，怎么写main.js。<br>如果我们的代码不依赖任何其他模块，那么可以直接写入javascript代码。</p><blockquote><p> // main.js<br>　　alert(“加载成功！”);</p></blockquote><p>但这样的话，就没必要使用require.js了。真正常见的情况是，主模块依赖于其他模块，这时就要使用AMD规范定义的的require()函数。</p><blockquote><p> // main.js<br>　　require([‘moduleA’, ‘moduleB’, ‘moduleC’], function (moduleA, moduleB, moduleC){<br>　　　　// some code here<br>　　});</p></blockquote><p>require()函数接受两个参数。第一个参数是一个数组，表示所依赖的模块，上例就是[‘moduleA’, ‘moduleB’, ‘moduleC’]，即主模块依赖这三个模块；第二个参数是一个回调函数，当前面指定的模块都加载成功后，它将被调用。加载的模块会以参数形式传入该函数，从而在回调函数内部就可以使用这些模块。</p><p>require()异步加载moduleA，moduleB和moduleC，浏览器不会失去响应；它指定的回调函数，只有前面的模块都加载成功后，才会运行，解决了依赖性的问题。</p><p>下面，我们看一个实际的例子。<br>假定主模块依赖jquery、underscore和backbone这三个模块，main.js就可以这样写：</p><blockquote><p>require([‘jquery’, ‘underscore’, ‘backbone’], function ($, _, Backbone){<br>　　　　// some code here<br>　　});</p></blockquote><p>require.js会先加载jQuery、underscore和backbone，然后再运行回调函数。主模块的代码就写在回调函数中。</p><h2 id="模块的加载"><a href="#模块的加载" class="headerlink" title="模块的加载"></a><font color="#0099ff" size="3" face="黑体">模块的加载</font></h2><p>上一节最后的示例中，主模块的依赖模块是[‘jquery’, ‘underscore’, ‘backbone’]。默认情况下，require.js假定这三个模块与main.js在同一个目录，文件名分别为jquery.js，underscore.js和backbone.js，然后自动加载。</p><p>使用require.config()方法，我们可以对模块的加载行为进行自定义。require.config()就写在主模块（main.js）的头部。参数就是一个对象，这个对象的paths属性指定各个模块的加载路径。</p><blockquote><p> require.config({<br>　　　　paths: {<br>　　　　　　“jquery”: “jquery.min”,<br>　　　　　　“underscore”: “underscore.min”,<br>　　　　　　“backbone”: “backbone.min”<br>　　　　}<br>　　});</p></blockquote><p>上面的代码给出了三个模块的文件名，路径默认与main.js在同一个目录（js子目录）。如果这些模块在其他目录，比如js/lib目录，则有两种写法。一种是逐一指定路径。</p><blockquote><p> require.config({<br>　　　　paths: {<br>　　　　　　“jquery”: “lib/jquery.min”,<br>　　　　　　“underscore”: “lib/underscore.min”,<br>　　　　　　“backbone”: “lib/backbone.min”<br>　　　　}<br>　　});</p></blockquote><p>另一种则是直接改变基目录（baseUrl）。</p><blockquote><p> require.config({<br>　　　　baseUrl: “js/lib”,<br>　　　　paths: {<br>　　　　　　“jquery”: “jquery.min”,<br>　　　　　　“underscore”: “underscore.min”,<br>　　　　　　“backbone”: “backbone.min”<br>　　　　}<br>　　});</p></blockquote><p>如果某个模块在另一台主机上，也可以直接指定它的网址，比如：</p><blockquote><p> require.config({<br>　　　　paths: {<br>　　　　　　“jquery”: “<a href="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min&quot;" target="_blank" rel="noopener">https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min&quot;</a><br>　　　　}<br>　　});</p></blockquote><p>require.js要求，每个模块是一个单独的js文件。这样的话，如果加载多个模块，就会发出多次HTTP请求，会影响网页的加载速度。因此，require.js提供了一个<a href="https://requirejs.org/docs/optimization.html" target="_blank" rel="noopener">优化工具</a>，当模块部署完毕以后，可以用这个工具将多个模块合并在一个文件中，减少HTTP请求数。</p><h2 id="AMD模块的写法"><a href="#AMD模块的写法" class="headerlink" title="AMD模块的写法"></a><font color="#0099ff" size="3" face="黑体">AMD模块的写法</font></h2><p>require.js加载的模块，采用AMD规范。也就是说，模块必须按照AMD的规定来写。</p><p>具体来说，就是模块必须采用特定的define()函数来定义。如果一个模块不依赖其他模块，那么可以直接定义在define()函数之中。</p><p>假定现在有一个math.js文件，它定义了一个math模块。那么，math.js就要这样写：</p><blockquote><p> // math.js<br>　　define(function (){<br>　　　　var add = function (x,y){<br>　　　　　　return x+y;<br>　　　　};<br>　　　　return {<br>　　　　　　add: add<br>　　　　};<br>　　});</p></blockquote><p>加载方法如下：</p><blockquote><p> // main.js<br>　　require([‘math’], function (math){<br>　　　　alert(math.add(1,1));<br>　　});</p></blockquote><p>如果这个模块还依赖其他模块，那么define()函数的第一个参数，必须是一个数组，指明该模块的依赖性。</p><blockquote><p> define([‘myLib’], function(myLib){<br>　　　　function foo(){<br>　　　　　　myLib.doSomething();<br>　　　　}<br>　　　　return {<br>　　　　　　foo : foo<br>　　　　};<br>　　});</p></blockquote><p>当require()函数加载上面这个模块的时候，就会先加载myLib.js文件。</p><h2 id="加载非规范的模块"><a href="#加载非规范的模块" class="headerlink" title="加载非规范的模块"></a><font color="#0099ff" size="3" face="黑体">加载非规范的模块</font></h2><p>理论上，require.js加载的模块，必须是按照AMD规范、用define()函数定义的模块。但是实际上，虽然已经有一部分流行的函数库（比如jQuery）符合AMD规范，更多的库并不符合。那么，require.js是否能够加载非规范的模块呢？</p><p>回答是可以的。</p><p>这样的模块在用require()加载之前，要先用require.config()方法，定义它们的一些特征。</p><p>举例来说，underscore和backbone这两个库，都没有采用AMD规范编写。如果要加载它们的话，必须先定义它们的特征。</p><blockquote><p> require.config({<br>　　　　shim: {<br>　　　　　　‘underscore’:{<br>　　　　　　　　exports: ‘_’<br>　　　　　　},<br>　　　　　　‘backbone’: {<br>　　　　　　　　deps: [‘underscore’, ‘jquery’],<br>　　　　　　　　exports: ‘Backbone’<br>　　　　　　}<br>　　　　}<br>　　});</p></blockquote><p>require.config()接受一个配置对象，这个对象除了有前面说过的paths属性之外，还有一个shim属性，专门用来配置不兼容的模块。具体来说，每个模块要定义（1）exports值（输出的变量名），表明这个模块外部调用时的名称；（2）deps数组，表明该模块的依赖性。</p><p>比如，jQuery的插件可以这样定义：</p><blockquote><p> shim: {<br>　　　　‘jquery.scroll’: {<br>　　　　　　deps: [‘jquery’],<br>　　　　　　exports: ‘jQuery.fn.scroll’<br>　　　　}<br>　　}</p></blockquote><h2 id="require-js插件"><a href="#require-js插件" class="headerlink" title="require.js插件"></a><font color="#0099ff" size="3" face="黑体">require.js插件</font></h2><p>require.js还提供一系列<a href="https://github.com/requirejs/requirejs/wiki/Plugins" target="_blank" rel="noopener">插件</a>，实现一些特定的功能。</p><p>domready插件，可以让回调函数在页面DOM结构加载完成后再运行。</p><blockquote><p> require([‘domready!’], function (doc){<br>　　　　// called once the DOM is ready<br>　　});</p></blockquote><p>text和image插件，则是允许require.js加载文本和图片文件。</p><blockquote><p>　　 define([<br>　　　　‘text!review.txt’,<br>　　　　‘image!cat.jpg’<br>　　　　],<br>　　　　function(review,cat){<br>　　　　　　console.log(review);<br>　　　　　　document.body.appendChild(cat);<br>　　　　}<br>　　);</p></blockquote><p>类似的插件还有json和mdown，用于加载json文件和markdown文件。（完）</p><p>另一个人的概括(有点简单)：</p><p>AMD就只有一个接口：define(id?,dependencies?,factory);</p><p>它要在声明模块的时候制定所有的依赖(dep)，并且还要当做形参传到factory中，像这样：</p><blockquote><p>define([‘dep1’,’dep2’],function(dep1,dep2){…});</p></blockquote><p>要是没什么依赖，就定义简单的模块，下面这样就可以啦：</p><blockquote><pre><code>   define(function(){
    var exports = {};
    exports.method = function(){...};
    return exports;
});
</code></pre></blockquote><p>咦，这里有define，把东西包装起来啦，那Node实现中怎么没看到有define关键字呢，它也要把东西包装起来呀，其实吧，只是Node隐式包装了而已…..</p><p>这有AMD的WIKI中文版，讲了很多蛮详细的东西，用到的时候可以查看：<a href="https://github.com/amdjs/amdjs-api/wiki/AMD-(%E4%B8%AD%E6%96%87%E7%89%88" target="_blank" rel="noopener">AMD的WIKI中文版</a></p><h1 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h1><p>大名远扬的玉伯写了seajs，就是遵循他提出的CMD规范，与AMD蛮相近的，不过用起来感觉更加方便些，最重要的是中文版，应有尽有：<a href="http://www6.seajs.org/?s_token=1548666648.0457692136&amp;kw=Javascript&amp;term=learn%20javascript&amp;term=javascript%20example&amp;term=module%20loader&amp;term=api%20integration&amp;term=javascript%20online%20courses&amp;showDomain=1&amp;backfill=0&amp;tdfs=1#docs" target="_blank" rel="noopener">seajs官方doc</a></p><blockquote><p>define(function(require,exports,module){…});</p></blockquote><p>用过seajs吧，这个不陌生吧，对吧。</p><p>前面说AMD，说RequireJS实现了AMD，CMD看起来与AMD好像呀，那RequireJS与SeaJS像不像呢？</p><p>虽然CMD与AMD蛮像的，但区别还是挺明显的，官方非官方都有阐述和理解，我觉得吧，说的都挺好：</p><p><a href="https://github.com/seajs/seajs/issues/277" target="_blank" rel="noopener">官方阐述SeaJS与RequireJS异同</a></p><p><a href="https://www.douban.com/note/283566440/" target="_blank" rel="noopener">SeaJS与RequireJS的最大异同（这个说的也挺好)</a></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/2019/01/28/CommonJs-AMD-CMD/">js模块化编程弄懂CommonJS和AMD/CMD！</a></p><p><span>文章作者:</span><a href="/" title="访问 Honey 的个人博客">Honey</a></p><p><span>发布时间:</span>2019年01月28日 - 11:40</p><p><span>最后更新:</span>2019年01月28日 - 17:14</p><p><span>原始链接:</span><a href="/2019/01/28/CommonJs-AMD-CMD/" title="js模块化编程弄懂CommonJS和AMD/CMD！">https://zhanghuaxiao.github.io/2019/01/28/CommonJs-AMD-CMD/</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://zhanghuaxiao.github.io/2019/01/28/CommonJs-AMD-CMD/" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><footer class="post-footer"><div class="post-tags"><a href="/tags/CommonJS-AMD-CMD/" rel="tag"><i class="fa fa-tag"></i> CommonJS/AMD/CMD</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/01/27/Emojis-url/" rel="next" title="用 JavaScript 和 Emoji 做地址栏动画"><i class="fa fa-chevron-left"></i> 用 JavaScript 和 Emoji 做地址栏动画</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2019/01/29/gulp和webpack区别/" rel="prev" title="gulp和webpack区别">gulp和webpack区别<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="http://b-ssl.duitang.com/uploads/item/201411/01/20141101001054_u5MPu.jpeg" alt="Honey"><p class="site-author-name" itemprop="name">Honey</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">21</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">28</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Zhanghuaxiao" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://me.csdn.net/qq_40920780" target="_blank" title="CSDN"><i class="fa fa-fw fa-copyright"></i> CSDN</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/zhi-hu-zhe-ye-29-43-3/activities" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://segmentfault.com/u/honey_5b7eb253d4e32" target="_blank" title="思否"><i class="fa fa-fw fa-globe"></i> 思否</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CommonJS"><span class="nav-number">1.</span> <span class="nav-text">CommonJS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#原理"><span class="nav-number">1.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Browserify-的实现"><span class="nav-number">1.2.</span> <span class="nav-text">Browserify 的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tiny-Browser-Require"><span class="nav-number">1.3.</span> <span class="nav-text">Tiny Browser Require</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AMD"><span class="nav-number">2.</span> <span class="nav-text">AMD</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要用require-js？"><span class="nav-number">2.1.</span> <span class="nav-text">为什么要用require.js？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#require-js的加载"><span class="nav-number">2.2.</span> <span class="nav-text">require.js的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主模块的写法"><span class="nav-number">2.3.</span> <span class="nav-text">主模块的写法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模块的加载"><span class="nav-number">2.4.</span> <span class="nav-text">模块的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AMD模块的写法"><span class="nav-number">2.5.</span> <span class="nav-text">AMD模块的写法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加载非规范的模块"><span class="nav-number">2.6.</span> <span class="nav-text">加载非规范的模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#require-js插件"><span class="nav-number">2.7.</span> <span class="nav-text">require.js插件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CMD"><span class="nav-number">3.</span> <span class="nav-text">CMD</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Honey</span></div><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_uv">本站访客数:<span id="busuanzi_value_site_uv"></span> 人次</span></div> <span class="post-meta-divider">|</span><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共:18.4k 字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body></html>